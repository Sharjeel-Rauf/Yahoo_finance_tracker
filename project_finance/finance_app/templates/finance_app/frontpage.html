{% extends 'base.html' %}
{% load static %}
{% block title %}Welcome | {% endblock %}

{% block content %}
<div class="page-container">
    <h1 class="page-title">Yahoo Finance</h1>
</div>
{% include 'finance_app/sidebar.html' %}

<div class="content-container" style="margin-left: 30%;">
    <h2 style="color: white;">Strategy Payoff Diagram</h2>

    <div id="payoffDiagram"></div>

    <div class="container" style = "color: white;">
        <h1>Analysis Summary</h1>
        <div class="summary-content">
            {% for line in summary_content %}
                {% if line.option_leg %}
                    <div class="option-leg">{{ line.content }}</div>
                {% elif line.indent %}
                    <div class="indent">{{ line.content }}</div>
                {% else %}
                    <div>{{ line.content }}</div>
                {% endif %}
            {% endfor %}
        </div>
    </div>

    <p style = "color: white;">View the source data for {{ symbol_1 }} on <a href="{{ yahoo_finance_url }}" target='_blank'>Yahoo Finance</a></p>
    


    
    <div id="resultsSection" style="color: white;">
        <!-- Current price and error messages will be displayed here -->
    </div>
    
    <div id="optionsSection" style="color: white;">
        <div id="callsSection">
            <h3>Calls</h3>
            <div id="callsTableContainer" class="table-container">
                <!-- Calls table will be displayed here -->
            </div>
        </div>
        <div id="putsSection">
            <h3>Puts</h3>
            <div id="putsTableContainer" class="table-container">
                <!-- Puts table will be displayed here -->
            </div>
        </div>
    </div>
    
</div>





<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script>
          // Load the JSON data passed from Django
        var fig_json = JSON.parse('{{ fig_json | escapejs }}');


        // Plot the chart using Plotly
        Plotly.newPlot('payoffDiagram', fig_json.data, fig_json.layout);

document.addEventListener('DOMContentLoaded', function () {
    var tickerInput = document.getElementById('tickerSymbolInput');
    var strategySelect = document.getElementById('strategySelect');
    var tradeDurationSelect = document.getElementById('tradeDurationSelect');
    var expiryDateSelect = document.getElementById('expiryDateSelect');
    var isInitialLoad = true;


    // Function to fetch all inputs with current parameters
    function fetchAllInputs(symbol, tradeDuration, expirationDate = null, strategy = 'Covered Call') {


        var i = 0;
var sharesArray = [];
var shareCostArray = [];
var strikeArray = [];
var premiumArray = [];
var quantityArray = [];

while (true) {
    var sharesElement = document.getElementById(`shares_${i}`);
    var shareCostElement = document.getElementById(`share_cost_${i}`);
    var strikeElement = document.getElementById(`Strike_${i}`);
    var premiumElement = document.getElementById(`premium_${i}`);
    var quantityElement = document.getElementById(`quantity_${i}`);

    // Check if all elements are null
    if (!sharesElement && !shareCostElement && !strikeElement && !premiumElement && !quantityElement) {
        break;
    }

    var shares = sharesElement ? parseInt(sharesElement.value) : null;
    var shareCost = shareCostElement ? parseFloat(shareCostElement.value) : null;
    var strike = strikeElement ? parseFloat(strikeElement.value) : null;
    var premium = premiumElement ? parseFloat(premiumElement.value) : null;
    var quantity = quantityElement ? parseInt(quantityElement.value) : null;

    // Push values to respective arrays
    sharesArray.push(shares);
    shareCostArray.push(shareCost);
    strikeArray.push(strike);
    premiumArray.push(premium);
    quantityArray.push(quantity);

    i++;
}

// Remove null values from arrays
sharesArray = sharesArray.filter(value => value !== null);
shareCostArray = shareCostArray.filter(value => value !== null);
strikeArray = strikeArray.filter(value => value !== null);
premiumArray = premiumArray.filter(value => value !== null);
quantityArray = quantityArray.filter(value => value !== null);

// Convert arrays into values for variables
var shares = sharesArray.length > 0 ? sharesArray[0] : null;
var shareCost = shareCostArray.length > 0 ? shareCostArray[0] : null;
var strike = strikeArray.length > 0 ? strikeArray[0] : null;
var premium = premiumArray.length > 0 ? premiumArray[0] : null;
var quantity = quantityArray.length > 0 ? quantityArray[0] : null;

// Debugging output for the variables
console.log('Shares:', shares);
console.log('Share Cost:', shareCost);
console.log('Strike:', strike);
console.log('Premium:', premium);
console.log('Quantity:', quantity);

        $.ajax({
            url: "{% url 'process_all_inputs' %}",
            type: 'GET',
            data: {
                "strategy": strategy,
                "symbol": symbol,
                "trade_duration": tradeDuration,
                "expiration_date": expirationDate,
                "shares": shares,
                "share_cost": shareCost,
                "strike": strike,
                "premium": premium,
                "quantity": quantity,
            },
            success: function (response) {
                // Handle expiration dates
                if (response.expiration_dates) {
                    expiryDateSelect.innerHTML = '';
                    response.expiration_dates.forEach(function (date) {
                        var option = document.createElement('option');
                        option.value = date;
                        option.textContent = date;
                        expiryDateSelect.appendChild(option);
                    });

                    if (isInitialLoad) {
                        isInitialLoad = false;
                        expiryDateSelect.dispatchEvent(new Event('change'));
                    }
                }

                // Handle current price
                if (response.current_price) {
                    var formattedPrice = parseFloat(response.current_price).toFixed(2);
                    document.getElementById('resultsSection').innerHTML = `Current price of ${symbol}: $${formattedPrice}`;
                }

                // Handle calls data
                if (response.calls_data) {
                    var callsTable = createTable(response.calls_data);
                    document.getElementById('callsTableContainer').innerHTML = callsTable;
                }

                // Handle puts data
                if (response.puts_data) {
                    var putsTable = createTable(response.puts_data);
                    document.getElementById('putsTableContainer').innerHTML = putsTable;
                }

    

                // Update share cost value
                if (response.current_price !== undefined) {
                    shareCostValue = parseFloat(response.current_price);
                }

                if (response.enriched_option_details) {
                    updateOptionLegs(response.enriched_option_details, response.current_price); // Pass shareCostValue correctly
                }

                // Handle errors
                if (response.error) {
                    console.log(`Error: ${response.error}`);
                    document.getElementById('resultsSection').innerHTML = `Error: ${response.error}`;
                }

            },
            error: function (error) {
                console.log('Error fetching data:', error);
                document.getElementById('resultsSection').innerHTML = 'Error fetching data';
            }
        });
    }

    function updateOptionLegs(optionLegs, current_price) {
        var container = document.getElementById('optionLegsContainer');
        container.innerHTML = '';

        optionLegs.forEach((leg, index) => {
            var div = document.createElement('div');
            div.classList.add('option-leg');
            div.id = `option-leg-${index + 1}`;

            console.log(`Processing leg ${index + 1}:`, leg);

            var html = `<h4>Option Leg ${index + 1}</h4>`;
            if (leg[0] == 'Stock') {
                var multipliedCurrentPrice = 10 * current_price; // Calculate multiplied current price
                console.log(`multipliedCurrentPrice: ${multipliedCurrentPrice}, currentPrice: ${current_price}`);

                html += `<label>Number of Shares</label>
                         <input type="number" min="1" max="1000" value="100" id="shares_${index}" class="option-input" /><br>
                         <label>Average Share Cost</label>
                         <input type="number" min="0.01" max="${multipliedCurrentPrice}" value="${current_price}" step="0.01" id="share_cost_${index}" class="option-input" />`;
            } else {
                html += `<label>${leg[1]}</label>
                         <select id="Strike_${index}" class="option-input">`;
                leg[2].strikes.forEach(strike => {
                    var selected = strike == leg[2].default_strike ? 'selected' : '';
                    html += `<option value="${strike}" ${selected}>${strike}</option>`;
                });
                html += `</select>
                         <label>Premium</label>
                         <input type="number" min="0.0" max="1000.0" value="${leg[2].default_premium}" step="0.1" id="premium_${index}" class="option-input" /><br>
                         <label>Quantity</label>
                         <input type="number" min="1" max="100" value="1" id="quantity_${index}" class="option-input" />`;
            }

            div.innerHTML = html;
            container.appendChild(div);
        });

        attachInputListeners();
    }

    function updatePremium(index, strikeValue, premiumValues) {
        var premiumInput = document.getElementById(`premium_${index}`);
        if (premiumValues && premiumValues[strikeValue] !== undefined) {
            premiumInput.value = premiumValues[strikeValue];
        } else {
            premiumInput.value = '';
        }
    }

    function getSelectedStrike() {
        var selectedStrikeInput = document.querySelector('.option-input[id^="Strike_"]');
        if (selectedStrikeInput) {
            return parseFloat(selectedStrikeInput.value);
        }
        return null;
    }

    function attachInputListeners() {
        var inputs = document.querySelectorAll('.option-input');
        inputs.forEach(function(input) {
            input.addEventListener('change', function() {
                var symbol = tickerInput.value;
                var tradeDuration = tradeDurationSelect.value;
                var expirationDate = expiryDateSelect.value;
                var strategy = strategySelect.value;

                // Update sharesValue if the input field is for shares
                if (this.id.startsWith('shares')) {
                    sharesValue = parseInt(this.value);
                }

                // Update shareCostValue if the input field is for share cost
                if (this.id.startsWith('share_cost')) {
                    shareCostValue = parseFloat(this.value);
                }

                // Get the selected strike price
                selectedStrike = getSelectedStrike();
                console.log("Selected strike:", selectedStrike); // Debug statement

                // Fetch data with updated values
                fetchAllInputs(symbol, tradeDuration, expirationDate, strategy);

                // Debug: Log the current values of sharesValue, shareCostValue, and selectedStrike
                console.log("Shares value:", sharesValue);
                console.log("Average share cost:", shareCostValue);
                console.log("Selected strike:", selectedStrike);
            });
        });
    }

    function createTable(data) {
        var table = '<table><thead><tr>';
        for (var key in data[0]) {
            table += `<th>${key}</th>`;
        }
        table += '</tr></thead><tbody>';
        data.forEach(function (row) {
            table += '<tr>';
            for (var key in row) {
                table += `<td>${row[key]}</td>`;
            }
            table += '</tr>';
        });
        table += '</tbody></table>';
        return table;
    }

    function fetchExpirationDates() {
        var symbol = tickerInput.value;
        var tradeDuration = tradeDurationSelect.value;
        var strategy = strategySelect.value;
        fetchAllInputs(symbol, tradeDuration, null, strategy);
    }

    // Fetch data on page load
    fetchExpirationDates();

    // Fetch data when any of the inputs change
    tickerInput.addEventListener('input', function () {
        fetchExpirationDates();
    });
    tradeDurationSelect.addEventListener('change', function () {
        fetchExpirationDates();
    });
    expiryDateSelect.addEventListener('change', function () {
        var symbol = tickerInput.value;
        var tradeDuration = tradeDurationSelect.value;
        var expirationDate = expiryDateSelect.value;
        var strategy = strategySelect.value;
        fetchAllInputs(symbol, tradeDuration, expirationDate, strategy);
    });
    strategySelect.addEventListener('change', function () {
        var symbol = tickerInput.value;
        var tradeDuration = tradeDurationSelect.value;
        var expirationDate = expiryDateSelect.value;
        var strategy = strategySelect.value;
        fetchAllInputs(symbol, tradeDuration, expirationDate, strategy);
    });
});


</script>

<style>
    .table-container {
        width: 100%;
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #ccc;
        margin-bottom: 20px;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        color: white;
    }
    th, td {
        padding: 8px;
        text-align: left;
        border-bottom: 1px solid #ddd;
    }
    th {
        background-color: #4CAF50;
    }

    .container {
            margin: 20px;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .summary-content {
            overflow-y: auto; /* Enable vertical scrolling */
            max-height: 300px; /* Set a maximum height */
        }

        .option-leg {
            padding-left: 20px;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .indent {
            padding-left: 40px;
            margin-bottom: 5px;
        }

        .container div {
            margin-bottom: 5px;
        }
</style>




{% endblock %}